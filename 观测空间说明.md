# 游戏观测空间详细说明

本游戏的强化学习环境使用 **29维连续观测向量**，所有值都归一化到 [0, 1] 范围内。

## 观测空间结构

### 总览

| 维度范围 | 数量 | 内容 | 说明 |
|---------|------|------|------|
| 0-2 | 3维 | 手牌统计 | 1点/2点/3点卡牌数量 |
| 3-12 | 10维 | 位置 | 环形地图位置的one-hot编码 |
| 13 | 1维 | 资源系数 | 当前资源系数（每绕圈+2） |
| 14 | 1维 | 当前回合 | 当前回合进度 |
| 15 | 1维 | 可普通收集 | 是否可以进行普通收集 |
| 16 | 1维 | 可连击 | 是否可以进行连击收集 |
| 17-18 | 2维 | 上次收集代价 | one-hot编码，区分收集1和收集2 |
| 19-27 | 9维 | 顾客需求 | 3个顾客各需要的冰/铁/火数量 |
| 28 | 1维 | 代币数 | 当前拥有的代币数 |

**总计：3 + 10 + 1 + 1 + 1 + 1 + 2 + 9 + 1 = 29维**

---

## 详细说明

### 1. 手牌统计（索引0-2，共3维）

表示当前手中1点、2点、3点卡牌的数量。

- **索引0**：1点卡数量 / 5（每回合最多5张牌）
- **索引1**：2点卡数量 / 5
- **索引2**：3点卡数量 / 5

**示例**：
```
手牌：[1点×2, 2点×1, 3点×2]
观测：[0.4, 0.2, 0.4]
```

---

### 2. 位置（索引3-12，共10维）

表示玩家在环形地图上的当前位置，使用one-hot编码。

地图布局：`[冰, 铁, 火, 冰, 铁, 火, 冰, 铁, 火, 火]`

**示例**：
```
当前位置：5（火）
观测：[0, 0, 0, 0, 0, 1, 0, 0, 0, 0]
      ↑位置5为1，其余为0
```

---

### 3. 资源系数（索引13，共1维）

当前的资源收集系数，初始为3，每绕过起点一次+2。

- **归一化**：资源系数 / 15（假设最大为15）

**示例**：
```
资源系数：5
观测：0.333 (5/15)
```

---

### 4. 当前回合（索引14，共1维）

当前回合在总回合数中的进度。

- **归一化**：当前回合数 / 总回合数

**示例**：
```
当前：第3回合/共10回合
观测：0.3 (3/10)
```

---

### 5. 是否可普通收集（索引15，共1维）

表示是否可以进行普通收集（刚移动后可以）。

- **值**：1.0（可以）或 0.0（不可以）

---

### 6. 是否可连击（索引16，共1维）

表示是否可以进行连击收集（上次收集用n点，这次可用n+1点连击）。

- **值**：1.0（可以）或 0.0（不可以）

**连击规则**：
- 上次收集用1点 → 这次用2点可连击
- 上次收集用2点 → 这次用3点可连击
- 上次收集用3点 → 无法连击

---

### 7. 上次收集代价（索引17-18，共2维）

使用2维one-hot编码表示上次收集使用的卡牌点数。

- **索引17**：上次收集是否用1点
- **索引18**：上次收集是否用2点

**编码规则**：
| 上次收集点数 | 索引17 | 索引18 |
|------------|-------|-------|
| 1点 | 1 | 0 |
| 2点 | 0 | 1 |
| 3点或未收集 | 0 | 0 |

**示例**：
```
上次收集用2点卡
观测：[0, 1]
```

---

### 8. 顾客需求（索引19-27，共9维）

表示3个顾客各自仍需要的资源数量（需求量 - 已有量）。

每个顾客占3维：`[冰仍需量, 铁仍需量, 火仍需量]`

- **顾客1**（索引19-21）：通常是VIP顾客（完成+4代币）
- **顾客2**（索引22-24）：普通顾客（完成+1代币）
- **顾客3**（索引25-27）：普通顾客（完成+1代币）

- **归一化**：仍需量 / 100（假设最大需求为100）

**示例**：
```
顾客1（VIP）: 火需求20已有0，冰需求20已有13
  仍需：火20, 冰7
  观测：[0.07, 0, 0.20]  (索引19-21)

顾客2（普通）: 铁需求30已有30，冰需求10已有5
  仍需：铁0, 冰5
  观测：[0.05, 0, 0]  (索引22-24)

顾客3（普通）: 火需求35已有2
  仍需：火33
  观测：[0, 0, 0.33]  (索引25-27)

完整观测（索引19-27）：
[0.07, 0, 0.20, 0.05, 0, 0, 0, 0, 0.33]
```

---

### 9. 代币数（索引28，共1维）

当前拥有的代币数量。

- **归一化**：代币数 / 20（假设最大为20）

**示例**：
```
代币：8个
观测：0.4 (8/20)
```

---

## 完整示例

假设游戏状态：
- 手牌：1点×1, 2点×0, 3点×4
- 位置：0（冰）
- 资源系数：3
- 当前回合：1/10
- 刚开始，未移动
- 未进行过收集
- 顾客1（VIP）：冰需100已有0，铁需40已有0
- 顾客2（普通）：冰需30已有0，铁需10已有0
- 顾客3（普通）：铁需35已有0
- 代币：0

则观测向量为：
```python
[
  # 手牌统计 (0-2)
  0.2, 0.0, 0.8,

  # 位置 (3-12)
  1.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0,

  # 资源系数 (13)
  0.2,

  # 当前回合 (14)
  0.1,

  # 可普通收集 (15)
  0.0,

  # 可连击 (16)
  0.0,

  # 上次收集代价 (17-18)
  0.0, 0.0,

  # 顾客需求 (19-27)
  1.0, 0.4, 0.0,    # 顾客1: 冰100, 铁40, 火0
  0.3, 0.1, 0.0,    # 顾客2: 冰30, 铁10, 火0
  0.0, 0.35, 0.0,   # 顾客3: 冰0, 铁35, 火0

  # 代币数 (28)
  0.0
]
```

---

## 为什么这样设计？

### 相比原36维观测的改进：

1. **收集状态更明确**：
   - 原：1维表示"是否可收集"（混淆了普通收集和连击）
   - 新：2维分别表示"可普通收集"和"可连击"

2. **上次收集代价更易拟合**：
   - 原：1维归一化值（0, 0.33, 0.67, 1.0）
   - 新：2维one-hot（明确区分收集1和收集2，连击的关键信息）

3. **顾客需求表示更直观**：
   - 原：每个顾客6维（类型+数量+进度）× 3 = 18维
   - 新：每个顾客3维（冰/铁/火仍需量）× 3 = 9维
   - 优势：
     - AI可以直接看到"还缺多少资源"
     - 不需要从"需求类型"和"进度"推断还缺什么
     - 维度更少，更容易学习

### 示例对比：

**顾客需求：火20已有7**

原始表示（6维）：
```
[资源类型ID, 需求量, 进度, ...]
[1.0, 0.2, 0.35, ...]
↓ AI需要计算
仍需量 = 需求量 × (1 - 进度) = 20 × 0.65 = 13
```

新表示（3维）：
```
[冰仍需, 铁仍需, 火仍需]
[0, 0, 0.13]
↓ 直接看出
火还需13个
```

---

## 注意事项

1. **归一化假设**：
   - 手牌：最多5张
   - 资源系数：最大15
   - 顾客需求：最大100
   - 代币数：最大20

   如果实际值超过假设最大值，观测值会 > 1.0，但环境仍会正常工作。

2. **Replay兼容性**：
   - Replay保存的是`get_observation()`的直接输出
   - 旧的36维replay无法用于新模型训练
   - 新的29维replay可以正常使用

3. **模型重训**：
   - 修改观测空间后，需要重新训练模型
   - 旧模型（36维输入）无法用于新环境（29维）

---

## 验证方法

可以使用提供的测试脚本验证观测空间：

```bash
# 测试基础观测
python3 test_observation.py

# 测试环境集成
python3 test_env_observation.py
```

测试会验证：
- 观测维度是否为29
- 观测值是否在[0, 1]范围内
- 观测是否符合观测空间定义
